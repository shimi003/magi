{% extends "base.html" %}
<!--
<!DOCTYPE html>
<html>
  <head lang = 'ja'>
    <meta charset="utf-8">
    <title>{{ view_name }}</title>
    <script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
    <script src="js/autocomplete_kana.js"></script>
-->
{% block extra_js %}
    // TODO divide below script to another js-file.
    <script type='text/javascript'>
      window.onload = function(){
        // TODO jsよりpythonのが得意そうだからdjangoから渡す
        var today = new Date();
        //today.setDate(today.getDate());
        var yyyy = today.getFullYear();
        var mm = ("0"+(today.getMonth()+1)).slice(-2);
        var dd = ("0"+today.getDate()).slice(-2);
        //console.log(yyyy+'-'+mm+'-'+dd); //デバッグ用
        document.getElementById("journal_date").value=yyyy+'-'+mm+'-'+dd;
      }
    </script>
    <script type='text/javascript'>
      // judge isNumber but... only br_1_a? is using??
      $("input[name='br_1_a']").blur(function(){
        if( $(this).val() != ''){
          if( $(this).val().match(/^[0-9]+$/) == null){
            alert('数字を入力してください');
          }
        }
      });

      // 金額入力欄の入力チェック（数字以外で背景をピンクにする）
      function chknum(obj){
        if(obj.value != ''){
          if(obj.value.match(/^[0-9,]+$/) ==null){
            //alert('数字のみを入力してください');
            //chknum[obj.name] = false;
            if(!!obj.style) obj.style.backgroundColor='lightpink';
          }
          else{
            if(!!obj.style) obj.style = .backgroundColor='transparent';
            //chknum[obj.name] = true;
          }
        }
        else{
          if(!!obj.style) obj.style.backgroundColor='transparent';
          //chknum[obj.name] = true;
        }
      };
      function chkForm(){

        //TODO 勘定科目が有効な場合のみ足す
        var br_sum =  (isNaN(parseInt($("input[name='br_1_a']").val()))? 0 : parseInt($("input[name='br_1_a']").val()))
                    + (isNaN(parseInt($("input[name='br_2_a']").val()))? 0 : parseInt($("input[name='br_2_a']").val()))
                    + (isNaN(parseInt($("input[name='br_3_a']").val()))? 0 : parseInt($("input[name='br_3_a']").val()))
                    + (isNaN(parseInt($("input[name='br_4_a']").val()))? 0 : parseInt($("input[name='br_4_a']").val()))
                    + (isNaN(parseInt($("input[name='br_5_a']").val()))? 0 : parseInt($("input[name='br_5_a']").val()))
        console.log("br_1_a = " + $("input[name='br_1_a']").val());
        console.log("br_sum = " + br_sum);

        var cr_sum =  (isNaN(parseInt($("input[name='cr_1_a']").val()))? 0 : parseInt($("input[name='cr_1_a']").val()))
                    + (isNaN(parseInt($("input[name='cr_2_a']").val()))? 0 : parseInt($("input[name='cr_2_a']").val()))
                    + (isNaN(parseInt($("input[name='cr_3_a']").val()))? 0 : parseInt($("input[name='cr_3_a']").val()))
                    + (isNaN(parseInt($("input[name='cr_4_a']").val()))? 0 : parseInt($("input[name='cr_4_a']").val()))
                    + (isNaN(parseInt($("input[name='cr_5_a']").val()))? 0 : parseInt($("input[name='cr_5_a']").val()))
        console.log("cr_sum = " + cr_sum);

        // 貸借の合計金額が０でなく、かつ一致したときのみページ遷移する
        if (br_sum != 0 && br_sum == cr_sum){
          return true;
        }
        else{
          //登録されない理由を返す
          if (br_sum == 0){
            $("#error").text('登録に失敗しました（金額未入力）')
          }
          else if(br_sum != cr_sum){
            br_sum_forming = br_sum.toLocaleString();
            cr_sum_forming = cr_sum.toLocaleString();
            def_forming = (br_sum - cr_sum).toLocaleString();
            $("#error").text('登録に失敗しました（貸借合計不一致） 借方合計=' + br_sum_forming + ' 貸方合計=' + cr_sum_forming + ' 差額=' + def_forming);
          }
          // koko niha konai hazu ...
          else{
            $("#error").text('登録に失敗しました（原因不明）');
          }
          return false;
        }
      };
    </script>
    <script>
    $(function() {
    	//コンボボックス設定
    	$( "#combobox" ).combobox();

    	//セレクト要素の表示・非表示
    	$( "#toggle" ).click(function() {
    		$( "#combobox" ).toggle();
    	});
    });
    </script>
{% endblock %}

{% block content %}
{% csrf_token %}
    <form method="post" name="journal_regist_form" action="regist/">
      {% csrf_token %}
      <!-- <input type="date" name = 'journal_date' id='journal_date' value='{{ today }}' /> -->
      <div class="container-fluid">
        <lable>日付</label>
        <input type="date" name = 'journal_date' id='journal_date' value="{{ journal_date }}" />
      </div>
      <br />
      <br />
      <div  class="container-fluid">
        <table class="table table-bordered table-striped">
          <thead class="thead-light">
            <tr>
              <th class="text-center">借方勘定科目</th>
              <th class="text-center">借方金額</th>
              <th class="text-center">貸方勘定科目</th>
              <th class="text-center">貸方金額</th>
            </tr>
          </thead>
          <tbody>
            {% for i in i_list %}
              <tr>
                  {% for borc in b_or_c %}
                  <td class="text-center">
                    <select name="{{ borc }}_{{ i }}_c">
                      {% for key, valuelist in listgroup.items %}
                        <optgroup label="{{ key }}">
                          {% for val in valuelist %}
                            <option value='{{ val.uid }}'>{{ val.label }}/{{ val.value }}</option>
                          {% endfor %}
                        </optgroup>
                      {% endfor %}
                    </select>
                  </td>
                  <td class="text-center">
                    <input type="text" name="{{ borc }}_{{ i }}_a" onblur="chknum(this)" />
                  </td>
                  {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      <label>コメントとか</label>
      <input type="text" name="note" cols="300" rows="3"/> <br />
      <div class="d-flex justify-content-center">
        <input type="submit" value="登録" name='regist' onclick="return chkForm()" />
        <input type="reset" value="キャンセル" name='cancel' />
      </div>
      {% if error %}
        <div class="alert alert-danger" role="alert">
      {% endif %}
      <label id = "error"></label>
      {% if error %}
      </div>
      {% endif %}
      {% if message %}
        <div class="alert alert-success" role="alert"><p>{{ message }}</p></div>
      {% endif %}
    </form >
{% endblock %}
